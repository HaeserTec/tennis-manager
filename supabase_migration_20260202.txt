-- 1. Create day_events table and policy
create table if not exists day_events (
  id text primary key,
  user_id uuid references auth.users not null default auth.uid(),
  date text not null,
  type text not null,
  note text,
  created_at bigint,
  updated_at bigint
);
alter table day_events enable row level security;
do $$ begin
  if not exists (select 1 from pg_policies where policyname = 'Users can manage their own day events') then
    create policy "Users can manage their own day events" on day_events for all using (auth.uid() = user_id);
  end if;
end $$;

-- 2. Create curriculums table and policy
create table if not exists curriculums (
  id text primary key,
  user_id uuid references auth.users not null default auth.uid(),
  name text not null,
  description text,
  level text,
  modules jsonb default '[]'::jsonb,
  created_at bigint,
  updated_at bigint
);
alter table curriculums enable row level security;
do $$ begin
  if not exists (select 1 from pg_policies where policyname = 'Users can manage their own curriculums') then
    create policy "Users can manage their own curriculums" on curriculums for all using (auth.uid() = user_id);
  end if;
end $$;

-- 3. Add missing columns to existing tables
alter table training_sessions add column if not exists series_id text;
alter table session_logs add column if not exists effort integer;
alter table session_logs add column if not exists is_shared_with_parent boolean default false;
alter table players add column if not exists curriculum_progress jsonb default '[]'::jsonb;
